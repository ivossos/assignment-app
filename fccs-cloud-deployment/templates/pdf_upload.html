<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PDF Upload Center - FCCS Consultant</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #0d1b2e 0%, #1b3a57 100%);
            min-height: 100vh;
            color: #333;
        }

        .header {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            padding: 1rem 2rem;
            box-shadow: 0 2px 20px rgba(0,0,0,0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .logo {
            font-size: 1.8rem;
            font-weight: bold;
            color: #0d1b2e;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .back-btn {
            background: #0d1b2e;
            color: white;
            border: none;
            padding: 0.75rem 1.5rem;
            border-radius: 25px;
            cursor: pointer;
            text-decoration: none;
            font-weight: 500;
            transition: all 0.3s ease;
        }

        .back-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(13, 27, 46, 0.3);
        }

        .container {
            max-width: 1200px;
            margin: 2rem auto;
            padding: 0 1rem;
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 2rem;
        }

        .upload-section, .history-section {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 2rem;
            box-shadow: 0 8px 32px rgba(0,0,0,0.1);
        }

        .section-title {
            font-size: 1.5rem;
            font-weight: bold;
            color: #0d1b2e;
            margin-bottom: 1.5rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .upload-area {
            border: 3px dashed #4caf50;
            border-radius: 15px;
            padding: 2rem;
            text-align: center;
            transition: all 0.3s ease;
            background: #f8fdf8;
            cursor: pointer;
            margin-bottom: 1rem;
        }

        .upload-area:hover {
            border-color: #22c55e;
            background: #f0fdf4;
            transform: translateY(-2px);
        }

        .upload-area.dragover {
            border-color: #22c55e;
            background: #dcfce7;
            transform: scale(1.02);
        }

        .upload-icon {
            font-size: 3rem;
            margin-bottom: 1rem;
            color: #4caf50;
        }

        .upload-text {
            font-size: 1.2rem;
            font-weight: 600;
            color: #0d1b2e;
            margin-bottom: 0.5rem;
        }

        .upload-subtext {
            color: #666;
            font-size: 0.9rem;
        }

        .file-input {
            display: none;
        }

        .file-info {
            background: #e3f2fd;
            border: 1px solid #bbdefb;
            border-radius: 10px;
            padding: 1rem;
            margin: 1rem 0;
            display: none;
        }

        .upload-btn {
            background: #4caf50;
            color: white;
            border: none;
            padding: 0.75rem 2rem;
            border-radius: 25px;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 500;
            transition: all 0.3s ease;
            display: none;
            margin: 1rem auto;
        }

        .upload-btn:hover {
            background: #45a049;
            transform: translateY(-2px);
        }

        .upload-btn:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
        }

        .validation-status {
            margin: 1rem 0;
            padding: 0.75rem;
            border-radius: 8px;
            font-weight: 500;
            display: none;
        }

        .validation-status.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .validation-status.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .validation-status.warning {
            background: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
        }

        .history-list {
            max-height: 500px;
            overflow-y: auto;
        }

        .document-item {
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 10px;
            padding: 1rem;
            margin-bottom: 0.75rem;
            transition: all 0.3s ease;
        }

        .document-item:hover {
            background: #e9ecef;
            transform: translateY(-1px);
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .doc-name {
            font-weight: 600;
            color: #0d1b2e;
            margin-bottom: 0.25rem;
        }

        .doc-meta {
            font-size: 0.8rem;
            color: #666;
            display: flex;
            justify-content: space-between;
            margin-bottom: 0.5rem;
        }

        .doc-validation {
            font-size: 0.8rem;
            padding: 0.25rem 0.5rem;
            border-radius: 5px;
            font-weight: 500;
        }

        .validation-high {
            background: #d4edda;
            color: #155724;
        }

        .validation-medium {
            background: #fff3cd;
            color: #856404;
        }

        .validation-low {
            background: #f8d7da;
            color: #721c24;
        }

        .doc-actions {
            margin-top: 0.5rem;
            display: flex;
            gap: 0.5rem;
        }

        .action-btn {
            background: transparent;
            border: 1px solid #0d1b2e;
            color: #0d1b2e;
            padding: 0.25rem 0.75rem;
            border-radius: 15px;
            cursor: pointer;
            font-size: 0.8rem;
            transition: all 0.3s ease;
        }

        .action-btn:hover {
            background: #0d1b2e;
            color: white;
        }

        .empty-state {
            text-align: center;
            color: #666;
            font-style: italic;
            padding: 2rem;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 1rem;
            margin-bottom: 1.5rem;
        }

        .stat-card {
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 10px;
            padding: 1rem;
            text-align: center;
        }

        .stat-number {
            font-size: 1.5rem;
            font-weight: bold;
            color: #0d1b2e;
        }

        .stat-label {
            font-size: 0.8rem;
            color: #666;
            margin-top: 0.25rem;
        }

        @media (max-width: 768px) {
            .container {
                grid-template-columns: 1fr;
                margin: 1rem auto;
                padding: 0 0.5rem;
            }

            .upload-section, .history-section {
                padding: 1.5rem;
            }
        }
    </style>
</head>
<body>
    <header class="header">
        <div class="logo">
            üéì PDF Upload Center
        </div>
        <a href="/" class="back-btn">‚Üê Back to Assistant</a>
    </header>

    <div class="container">
        <!-- Upload Section -->
        <div class="upload-section">
            <h2 class="section-title">
                üì§ Upload New Document
            </h2>

            <div class="upload-area" id="uploadArea" onclick="document.getElementById('pdfFile').click()">
                <div class="upload-icon">üìÑ</div>
                <div class="upload-text">Click to select PDF file</div>
                <div class="upload-subtext">or drag and drop ‚Ä¢ Max 50MB ‚Ä¢ PDF files only</div>
            </div>

            <input type="file" id="pdfFile" class="file-input" accept=".pdf">

            <div class="file-info" id="fileInfo">
                <div id="fileName"></div>
                <div id="fileSize"></div>
            </div>

            <div class="validation-status" id="validationStatus"></div>

            <button class="upload-btn" id="uploadBtn" onclick="uploadDocument()">
                üì§ Upload Document
            </button>
        </div>

        <!-- History Section -->
        <div class="history-section">
            <h2 class="section-title">
                üß† Knowledge Base Documents
            </h2>
            <div style="background: #e3f2fd; border: 1px solid #bbdefb; border-radius: 8px; padding: 0.75rem; margin-bottom: 1rem; font-size: 0.9rem; color: #1565c0;">
                üí° <strong>Knowledge Base:</strong> All uploaded documents become part of your FCCS AI knowledge base and can be referenced in conversations.
            </div>

            <div class="stats-grid" id="statsGrid">
                <div class="stat-card">
                    <div class="stat-number" id="totalDocs">0</div>
                    <div class="stat-label">Total Documents</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="totalSize">0 MB</div>
                    <div class="stat-label">Total Size</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="avgValidation">0%</div>
                    <div class="stat-label">Avg RAG Score</div>
                </div>
            </div>

            <div class="history-list" id="historyList">
                <div class="empty-state">
                    No documents uploaded yet. Upload your first PDF to get started!
                </div>
            </div>
        </div>
    </div>

    <!-- Footer to match main page -->
    <footer style="background: linear-gradient(135deg, #0d1b2e 0%, #1b3a57 100%); color: white; text-align: center; padding: 20px; margin-top: 2rem; position: relative; overflow: hidden;">
        <div style="position: relative; z-index: 1;">
            <div style="font-size: 1.5em; font-weight: bold; margin-bottom: 8px; text-shadow: 0 2px 4px rgba(0,0,0,0.3);">¬© 2025 CloseWise</div>
            <div style="font-size: 0.9em; opacity: 0.9; margin-bottom: 5px;">Professional Oracle FCCS Consulting Solutions</div>
            <div style="font-size: 0.8em; opacity: 0.7; font-style: italic;">Powered by AI ‚Ä¢ Built for Finance Excellence</div>
            <div style="font-size: 0.8em; opacity: 0.8; margin-top: 5px; display: flex; justify-content: center; align-items: center; gap: 10px; flex-wrap: wrap;">
                <span>üá∫üá∏ US Support:</span>
                <a href="tel:+15182496994" style="color: #fff; text-decoration: none; font-weight: 500;">+1 (518) 249-6994</a>
                <span>‚Ä¢</span>
                <span>üáßüá∑ Brazil:</span>
                <a href="tel:+5511932613103" style="color: #fff; text-decoration: none; font-weight: 500;">+55 11 93261-3103</a>
            </div>
        </div>
        <div style="position: absolute; top: 0; left: -100%; width: 100%; height: 2px; background: linear-gradient(90deg, transparent, rgba(255,255,255,0.4), transparent); animation: shimmer 3s infinite;"></div>
    </footer>

    <style>
        @keyframes shimmer {
            0% { left: -100%; }
            100% { left: 100%; }
        }

        footer a:hover {
            color: #ffd700 !important;
            text-decoration: underline !important;
        }
    </style>

    <script>
        let selectedFile = null;

        // Drag and drop functionality
        const uploadArea = document.getElementById('uploadArea');

        uploadArea.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadArea.classList.add('dragover');
        });

        uploadArea.addEventListener('dragleave', () => {
            uploadArea.classList.remove('dragover');
        });

        uploadArea.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadArea.classList.remove('dragover');

            const files = e.dataTransfer.files;
            if (files.length > 0) {
                handleFileSelection(files[0]);
            }
        });

        // File input change
        document.getElementById('pdfFile').addEventListener('change', (e) => {
            if (e.target.files.length > 0) {
                handleFileSelection(e.target.files[0]);
            }
        });

        function handleFileSelection(file) {
            if (!file) {
                console.error('No file provided to handleFileSelection');
                return;
            }

            selectedFile = file;

            // Validate file
            const validation = validateFile(file);
            showValidationStatus(validation);

            if (validation.valid) {
                showFileInfo(file);
                const uploadBtn = document.getElementById('uploadBtn');
                if (uploadBtn) {
                    uploadBtn.style.display = 'block';
                }
            } else {
                hideFileInfo();
                const uploadBtn = document.getElementById('uploadBtn');
                if (uploadBtn) {
                    uploadBtn.style.display = 'none';
                }
            }
        }

        function validateFile(file) {
            if (!file) {
                return {
                    valid: false,
                    type: 'error',
                    message: '‚ùå No file selected'
                };
            }

            if (!file.name) {
                return {
                    valid: false,
                    type: 'error',
                    message: '‚ùå Invalid file - missing name'
                };
            }

            const maxSize = 50 * 1024 * 1024; // 50MB
            const allowedTypes = ['application/pdf'];

            if (!file.type || !allowedTypes.includes(file.type)) {
                return {
                    valid: false,
                    type: 'error',
                    message: '‚ùå Please select a PDF file only'
                };
            }

            if (!file.size || file.size > maxSize) {
                return {
                    valid: false,
                    type: 'error',
                    message: '‚ùå File too large. Maximum size is 50MB'
                };
            }

            return {
                valid: true,
                type: 'success',
                message: '‚úÖ File is valid and ready for upload'
            };
        }

        function showValidationStatus(validation) {
            const status = document.getElementById('validationStatus');
            status.className = `validation-status ${validation.type}`;
            status.textContent = validation.message;
            status.style.display = 'block';
        }

        function showFileInfo(file) {
            if (!file || !file.name) {
                console.error('Invalid file object in showFileInfo');
                return;
            }

            const fileInfo = document.getElementById('fileInfo');
            const fileName = document.getElementById('fileName');
            const fileSize = document.getElementById('fileSize');

            if (fileName) {
                fileName.textContent = `üìÑ ${file.name}`;
            }
            if (fileSize) {
                fileSize.textContent = `üìä ${(file.size / 1024 / 1024).toFixed(2)} MB`;
            }
            if (fileInfo) {
                fileInfo.style.display = 'block';
            }
        }

        function hideFileInfo() {
            document.getElementById('fileInfo').style.display = 'none';
        }

        async function uploadDocument() {
            if (!selectedFile) {
                showValidationStatus({
                    valid: false,
                    type: 'error',
                    message: '‚ùå No file selected for upload'
                });
                return;
            }

            const uploadBtn = document.getElementById('uploadBtn');
            if (!uploadBtn) {
                console.error('Upload button not found');
                return;
            }

            const originalText = uploadBtn.textContent;

            uploadBtn.disabled = true;
            uploadBtn.textContent = '‚è≥ Uploading...';

            try {
                const formData = new FormData();
                formData.append('pdf_file', selectedFile);

                const response = await fetch('/upload_pdf', {
                    method: 'POST',
                    body: formData
                });

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }

                const result = await response.json();

                if (response.ok) {
                    showValidationStatus({
                        valid: true,
                        type: 'success',
                        message: `‚úÖ ${result.message || 'Upload successful!'}`
                    });

                    // Store file info before clearing selectedFile
                    const fileInfo = {
                        name: (selectedFile && selectedFile.name) ? selectedFile.name : 'Unknown File',
                        size: (selectedFile && selectedFile.size) ? selectedFile.size : 0
                    };

                    // Reset form immediately to prevent race conditions
                    selectedFile = null;
                    document.getElementById('pdfFile').value = '';
                    hideFileInfo();
                    uploadBtn.style.display = 'none';

                    // Create document object using stored file info and result data
                    const newDoc = {
                        filename: result.file_info?.filename || fileInfo.name,
                        upload_date: new Date().toISOString(),
                        size_mb: result.file_info?.size_mb || (fileInfo.size / (1024 * 1024)),
                        pages: result.file_info?.pages || result.pages || 'Processing...',
                        rag_score: result.rag_score || 85,
                        id: result.document_id || 'processing'
                    };

                    // Refresh history immediately and show the new document
                    setTimeout(() => {
                        loadDocumentHistory();
                    }, 500);

                    // Update local history for immediate display
                    if (!uploadedDocuments) uploadedDocuments = [];
                    uploadedDocuments.unshift(newDoc);
                    renderDocumentList(uploadedDocuments);
                    updateStatsFromDocuments(uploadedDocuments);

                } else {
                    throw new Error(result.error || 'Upload failed');
                }

            } catch (error) {
                showValidationStatus({
                    valid: false,
                    type: 'error',
                    message: `‚ùå Upload failed: ${error.message}`
                });
            } finally {
                uploadBtn.disabled = false;
                uploadBtn.textContent = originalText;
            }
        }

        let uploadedDocuments = [];

        async function loadDocumentHistory() {
            try {
                const response = await fetch('/list_uploaded_docs');
                const data = await response.json();

                if (response.ok) {
                    uploadedDocuments = data.documents || [];
                    updateStats(data.stats || {});
                    renderDocumentList(uploadedDocuments);
                } else {
                    console.error('Failed to load document history:', data.error);
                }
            } catch (error) {
                console.error('Error loading document history:', error);
            }
        }

        function updateStatsFromDocuments(documents) {
            const totalDocs = documents.length;
            const totalSize = documents.reduce((sum, doc) => sum + (doc.size_mb || 0), 0);
            const avgScore = documents.length > 0 ? 
                documents.reduce((sum, doc) => sum + (doc.rag_score || doc.fccs_relevance_score || 0), 0) / documents.length : 0;

            updateStats({
                total_documents: totalDocs,
                total_size_mb: totalSize,
                avg_rag_score: avgScore
            });
        }

        function updateStats(stats) {
            document.getElementById('totalDocs').textContent = stats.total_documents || 0;
            document.getElementById('totalSize').textContent = `${(stats.total_size_mb || 0).toFixed(1)} MB`;
            document.getElementById('avgValidation').textContent = `${Math.round(stats.avg_rag_score || 0)}%`;
        }

        function renderDocumentList(documents) {
            const historyList = document.getElementById('historyList');
            
            if (!historyList) {
                console.error('History list element not found');
                return;
            }

            if (!documents || documents.length === 0) {
                historyList.innerHTML = '<div class="empty-state">No documents uploaded yet. Upload your first PDF to get started!</div>';
                return;
            }

            historyList.innerHTML = documents.map(doc => {
                if (!doc) return '';
                
                const filename = doc.filename || doc.name || 'Unknown';
                const uploadDate = doc.upload_date || doc.uploaded_at || new Date().toISOString();
                const sizeMb = doc.size_mb || (doc.file_size ? doc.file_size / 1024 / 1024 : 0);
                const pages = doc.pages || 'Unknown';
                const ragScore = doc.rag_score || doc.fccs_relevance_score || 0;
                const docId = doc.id || doc.document_id || '';

                return `
                <div class="document-item">
                    <div class="doc-name">${filename}</div>
                    <div class="doc-meta">
                        <span>üìÖ ${new Date(uploadDate).toLocaleDateString()}</span>
                        <span>üìè ${sizeMb.toFixed(2)} MB</span>
                        <span>üìÑ ${pages} pages</span>
                    </div>
                    <div class="doc-validation ${getValidationClass(ragScore)}">
                        üß† Knowledge Base Score: ${Math.round(ragScore)}%
                    </div>
                    <div class="doc-actions">
                        <button class="action-btn" onclick="viewDocument('${docId}')">üëÅÔ∏è View</button>
                        <button class="action-btn" onclick="searchInDocument('${docId}')">üîç Search</button>
                        <button class="action-btn" onclick="deleteDocument('${docId}')">üóëÔ∏è Delete</button>
                    </div>
                </div>
                `;
            }).filter(html => html !== '').join('');
        }

        function getValidationClass(score) {
            if (score >= 70) return 'validation-high';
            if (score >= 40) return 'validation-medium';
            return 'validation-low';
        }

        async function viewDocument(docId) {
            alert(`Viewing document ${docId} - Feature coming soon!`);
        }

        async function searchInDocument(docId) {
            const query = prompt('Enter search query:');
            if (query) {
                alert(`Searching for "${query}" in document ${docId} - Feature coming soon!`);
            }
        }

        async function deleteDocument(docId) {
            if (confirm('Are you sure you want to delete this document?')) {
                try {
                    const response = await fetch(`/delete_document/${docId}`, {
                        method: 'DELETE'
                    });

                    if (response.ok) {
                        loadDocumentHistory();
                    } else {
                        const error = await response.json();
                        alert(`Delete failed: ${error.error}`);
                    }
                } catch (error) {
                    alert(`Delete failed: ${error.message}`);
                }
            }
        }

        // Load document history on page load
        document.addEventListener('DOMContentLoaded', () => {
            loadDocumentHistory();
        });
    </script>
</body>
</html>